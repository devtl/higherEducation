---
title: 'Project 2: US Higher Education Dataset'
author: "Devin Luu"
resource_files:
- .Renviron
output:
  html_notebook:
    code_folding: hide
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
---
```{r setup, include=FALSE}
library(tidyverse)
library(data.world)
library(gridExtra)
library(shiny)
library(fiftystater)
library(mapproj)

knitr::opts_chunk$set(echo = TRUE)
```

## **R Session Info**  

```{r}
sessionInfo()
```

## **Github Link** 
(https://github.com/devtl/higherEducation)

## **Connecting to data.world** 
```{r}
project <- "https://data.world/devtl/f-17-edv-project-1"
data.world::set_config(cfg_env("DW_API"))
df <- data.world::query(data.world::qry_sql("SELECT * FROM clean_merged_university_data"), dataset = project)

maxTuit <- max(df$in_state_tuition,na.rm = TRUE)

```

## **Introduction** 
This is the notebook for Project 2 for Dr. Cannata's class CS 329E, Data Visualization. We will replicate the various plots in his Tableau overview in R and introduce basic elements of Shiny.

We will be working with the [US Higher Education dataset](https://data.world/devtl/us-higher-education) on data.world to predict tuition prices across various factors.

## Scatterplots

Scatter and trend analysis for in-state tuition at various higher education institutions in the United States.

```{r}
inputPanel(
  
  selectInput("state", label = "States:", multiple = TRUE,
                     choices = unique(df$state), selected = "AL"),
  sliderInput("tuitMin", label = "Select Minimum Tuition",
              min = 0, max = maxTuit, value = 0, step = 100),
  sliderInput("tuitMax", label = "Select Maximum Tuition",
              min = 0, max = maxTuit, value = maxTuit, step = 100)
)

renderPlot({
  
  pl1 <- ggplot(
    na.omit(df), 
    mapping = aes(avg_sat_score, in_state_tuition)
  ) + 
    geom_point(size = 2, alpha = 0.33) + 
    geom_smooth(method = "lm") + 
    labs(x = "Avg SAT Score", y="In-state Tuition", title = "Nationwide Trend") +
    theme_minimal()
  
  pl2 <- ggplot(
    na.omit(subset(df, state %in% as.character(input$state))), 
    mapping = aes(avg_sat_score, in_state_tuition, color = state)
  ) + 
    geom_point(size = 3, alpha = 0.33) + 
    geom_smooth(method = "lm", se = FALSE) + 
    ylim(input$tuitMin, input$tuitMax) +
    labs(x = "Avg SAT Score", y="In-state Tuition", title = "State Trends") +
    theme_minimal()
  
  grid.arrange(pl1,pl2, nrow = 2)
  
})

```

## Map Plot
```{r}
#Make Geolocation data frame with a quantitative variable
mapdf <- fifty_states
inState <- aggregate(in_state_tuition ~ state, data = df, FUN = mean)

rep <- tibble(
  state = c(
    "AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA",
    "KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ",
    "NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT",
    "VA","WA","WV","WI","WY"), 
  id = c("alabama", "alaska", "arizona", "arkansas", "california", "colorado", "connecticut", 
         "delaware", "florida", "georgia", "hawaii", "idaho", "illinois", "indiana", "iowa",
         "kansas", "kentucky", "louisiana", "maine", "maryland", "massachusetts", "michigan",
         "minnesota", "mississippi", "missouri", "montana", "nebraska", "nevada", "new hampshire", 
         "new jersey","new mexico", "new york", "north carolina", "north dakota", "ohio", 
         "oklahoma", "oregon", "pennsylvania", "rhode island", "south carolina", 
         "south dakota", "tennessee", "texas", "utah", "vermont", "virginia", "washington", 
         "west virginia", "wisconsin", "wyoming"))

inState <- merge(inState,rep, by = "state")

mapdf <- merge(mapdf, inState, by = "id", all.x = TRUE)

# map_id creates the aesthetic mapping to the state name column in your data
renderPlot({
  ggplot(mapdf, aes(long, lat, map_id = id)) + 
  geom_map(aes(fill = -in_state_tuition), map = fifty_states) + 
  coord_map() + labs(fill = "Average In-State Tuition") +
  scale_x_continuous(breaks = NULL, labels = NULL, name = NULL) + 
  scale_y_continuous(breaks = NULL, labels = NULL, name = NULL) +
  theme_minimal()
})

```

## Barplots

States arranged by highest average in-state tuition.

```{r}
renderPlot({
  ggplot(na.omit(df), 
         aes(
           reorder(state, -in_state_tuition, function(x){mean(x)}), 
           in_state_tuition))+ 
    geom_bar(fill = "tomato3", stat = "summary", fun.y=mean) +
    labs(x = "State", y="In-state Tuition", title = "Nationwide Trend") +
    theme_minimal()
  
})
```

## Time Forecasts

Here we look at yearly changes in average tuition and compare the nationwide average to individual states.

```{r}
inputPanel(
  selectInput("state2", label = "States:", multiple = TRUE,
              choices = unique(df$state), selected = "AL")
)

renderPlot({
  
  pl3 <- ggplot(na.omit(df), mapping = aes(year, in_state_tuition)) + 
    geom_point(stat = "summary", fun.y = mean, size = 2, alpha = 0.33) +
    geom_line(stat = "summary", fun.y = mean, size = 2, alpha = 0.33) +
    scale_x_continuous(breaks = seq(2003, 2014, by = 1)) + 
    labs(x = "Year", y="In-state Tuition", title = "Nationwide Trend") + 
    theme_minimal()
  
  pl4 <- ggplot(
    na.omit(subset(df, state %in% as.character(input$state2))), 
    mapping = aes(year, in_state_tuition)) + 
    geom_point(stat = "summary", fun.y = mean, size = 2, alpha = 0.33) +
    geom_line(stat = "summary", fun.y = mean, size = 2, alpha = 0.33) + 
    scale_x_continuous(breaks = seq(2003, 2014, by = 1))  +
    labs(x = "Year", y="In-state Tuition", title = "State Trend") + 
    theme_minimal()
  
  grid.arrange(pl3, pl4, nrow=2)
  
})
```

